# -*- coding: utf-8 -*-
"""worship-ai

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lGpw1qCR63PsvRvck9_oLZ6GJayiFhR5
"""

import openai
import requests
import json

import os

# === 🔐 從環境變數讀取金鑰與資料庫 ID ===
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
NOTION_API_KEY = os.environ.get("NOTION_API_KEY")
DB_WORSHIP_HISTORY = os.environ.get("DB_WORSHIP_HISTORY")
DB_SONGS = os.environ.get("DB_SONGS")

openai.api_key = OPENAI_API_KEY

notion_headers = {
    "Authorization": f"Bearer {NOTION_API_KEY}",
    "Notion-Version": "2022-06-28",
    "Content-Type": "application/json"
}

conversation_history = []  # 🧠 新增上下文記憶

# === ⛏️ 工具方法：抽取 Notion 欄位 ===
def extract_text(property_item):
    if not property_item:
        return ""
    if "title" in property_item:
        return "".join([t["plain_text"] for t in property_item["title"]])
    if "rich_text" in property_item:
        return "".join([t["plain_text"] for t in property_item["rich_text"]])
    if "multi_select" in property_item:
        return ", ".join([t["name"] for t in property_item["multi_select"]])
    if "people" in property_item:
        return ", ".join([t["name"] for t in property_item["people"]])
    if "date" in property_item and property_item["date"]:
        return property_item["date"].get("start", "")
    return str(property_item)

# === 🔍 抓取 Notion 資料 ===
def fetch_notion_db(database_id):
    url = f"https://api.notion.com/v1/databases/{database_id}/query"
    all_data = []
    next_cursor = None
    while True:
        payload = {"page_size": 100}
        if next_cursor:
            payload["start_cursor"] = next_cursor
        res = requests.post(url, headers=notion_headers, json=payload)
        res.raise_for_status()
        data = res.json()
        all_data.extend(data.get("results", []))
        next_cursor = data.get("next_cursor")
        if not next_cursor:
            break
    return all_data

# === 🧠 查詢歌曲資料庫建立 ID ➜ 名稱對應表（含歌詞） ===
def build_song_lookup(song_data):
    lookup = {}
    for item in song_data:
        song_id = item["id"]
        props = item["properties"]
        name = extract_text(props.get("歌名"))
        link = extract_text(props.get("連結"))
        song_type = extract_text(props.get("類型"))
        lyrics = extract_text(props.get("歌詞"))
        lookup[song_id] = {
            "name": name,
            "type": song_type,
            "link": link,
            "lyrics": lyrics
        }
    return lookup

# === 🧠 使用 GPT 查詢 ===
def ask_gpt(user_question, notion_data):
    formatted_data = []
    for row in notion_data:
        props = row["properties"]

        def resolve_songs(field_name):
            ids = props.get(field_name, {}).get("relation", [])
            return [
                f"{songs_lookup[s['id']]['name']} ({songs_lookup[s['id']]['type']})\n{songs_lookup[s['id']]['link']}\n歌詞：{songs_lookup[s['id']]['lyrics']}"
                if s["id"] in songs_lookup else s["id"]
                for s in ids
            ]

        item = {
            "主日日期": extract_text(props.get("主日日期")),
            "講道題目": extract_text(props.get("講道題目")),
            "講員": extract_text(props.get("講員")),
            "經文": extract_text(props.get("經文")),
            "主題": extract_text(props.get("主題")),
            "快歌": resolve_songs("快歌（詳情）"),
            "慢歌": resolve_songs("慢歌（詳情）"),
        }
        formatted_data.append(item)

    prompt = f"""
你是一個敬拜團資料查詢助手，會根據經文、主題、講道內容、歌詞，幫忙推薦詩歌。

請針對使用者的問題，找出最符合的主日紀錄或歌曲。
除了條列資料外，請嘗試說明「為什麼選這首歌」，例如：
- 哪句歌詞跟講道主題呼應
- 歌曲傳達的敬拜氛圍與經文關聯
- 如果沒有完全相符的，可以說明推薦原因

請用清楚條列格式回覆：
- 日期、講員、講題、經文、主題
- 快歌與慢歌（附連結與歌詞片段）
- 每首歌簡短的推薦理由（可用簡單語句說明與經文、主題的連結）

這是你目前可參考的主日資料（最多列出 30 筆）：

{json.dumps(formatted_data[:30], ensure_ascii=False, indent=2)}

使用者的問題是：「{user_question}」
"""

    messages = [
        {"role": "system", "content": "你是敬拜團歷史資料查詢助手，請親切自然地幫助使用者查找歌曲，能根據上下文理解他的意思。"},
        *conversation_history,
        {"role": "user", "content": prompt}
    ]

    response = openai.chat.completions.create(
        model="gpt-4o",
        messages=messages,
        temperature=0.3
    )

    # 記住上下文
    conversation_history.append({"role": "user", "content": user_question})
    conversation_history.append({"role": "assistant", "content": response.choices[0].message.content})

    return response.choices[0].message.content

# === 🚀 執行流程 ===
print("⏳ 下載 Notion 資料中...")
worship_data = fetch_notion_db(DB_WORSHIP_HISTORY)
song_data = fetch_notion_db(DB_SONGS)
songs_lookup = build_song_lookup(song_data)

while True:
    user_input = input("\n💬 請輸入你想查的問題（或輸入 q 離開）：")
    if user_input.lower() == "q":
        print("👋 再見！")
        break

    print("⏳ GPT 正在查詢資料，請稍候...")
    try:
        reply = ask_gpt(user_input, worship_data)
        print("\n📋 回覆內容：\n")
        print(reply)
    except Exception as e:
        print("⚠️ 發生錯誤：", e)